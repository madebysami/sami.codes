<button
  type="button"
  aria-label="Switch theme"
  class="theme-toggle rounded-lg px-4 py-2 border border-brand bg-surface text-brand text-xs font-bold font-mono transition-all hover:bg-brand hover:text-surface focus:outline-none focus-visible:ring-2 focus-visible:ring-brand min-w-[140px]"
  data-theme-toggle
  tabindex="0"
>
  Switch Theme
</button>
<span class="theme-toggle-announcer sr-only" aria-live="polite"></span>

<script>
  const themes = [
    { name: 'midnight', complaint: 'Too Dark!' },
    { name: 'mint', complaint: 'Too Pastel!' },
    { name: 'terminal', complaint: 'Too Hackery!' },
    { name: 'blueprint', complaint: 'Too Blue!' },
    { name: 'vampire', complaint: 'Too Edgy!' },
    { name: 'coffee', complaint: 'Too Cozy!' },
    { name: 'flashbang', complaint: 'Too Bright!' },
    { name: 'abyss', complaint: "Can't See!" },
    { name: 'retrowave', complaint: 'Too Discoy!' },
    { name: 'grayscale', complaint: 'Too Boring!' },
    { name: 'desert', complaint: 'Too Dry!' },
    { name: 'oceanic', complaint: 'Too Wet!' },
    { name: 'royal', complaint: 'Too Fancy!' },
    { name: 'forest', complaint: 'Too Earthy!' },
    { name: 'candy', complaint: 'Too Sweet!' },
  ]

  function setTheme(themeName) {
    document.querySelectorAll('[data-theme-toggle]').forEach((btn) => {
      btn.textContent = 'Loading...'
      btn.classList.add('opacity-60', 'pointer-events-none')
    })

    // Remove all theme-* classes
    document.documentElement.className = document.documentElement.className
      .split(' ')
      .filter((c) => !c.startsWith('theme-'))
      .join(' ')

    if (themeName !== 'midnight') {
      document.documentElement.classList.add(`theme-${themeName}`)
    }

    localStorage.setItem('theme', themeName)

    setTimeout(() => {
      const themeObj = themes.find((t) => t.name === themeName) || themes[0]
      const complaint = themeObj.complaint

      document.querySelectorAll('[data-theme-toggle]').forEach((btn) => {
        btn.textContent = complaint
        btn.classList.remove('opacity-60', 'pointer-events-none')
        btn.setAttribute(
          'aria-label',
          `Switch theme (current: ${themeObj.name})`
        )
      })

      // Announce theme change for screen readers
      document
        .querySelectorAll('.theme-toggle-announcer')
        .forEach((announcer) => {
          const uppercaseName =
            themeObj.name.charAt(0).toUpperCase() + themeObj.name.slice(1)
          announcer.textContent = `Theme changed to ${uppercaseName}. ${complaint}`
        })

      updateFavicon()
    }, 100)
  }

  function updateFavicon() {
    const styles = getComputedStyle(document.documentElement)
    const brand = styles.getPropertyValue('--color-brand').trim() || '#38BDF8'
    const surface =
      styles.getPropertyValue('--color-surface').trim() || '#0F172A'
    const textPrimary =
      styles.getPropertyValue('--color-text-primary').trim() || '#F1F5F9'

    const svg = `<svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect width="64" height="64" fill="${surface}"/>
  <text x="2" y="45" font-family="monospace" font-size="24" fill="${brand}" font-weight="bold">&lt;</text>
  <text x="18" y="45" font-family="monospace" font-size="24" fill="${textPrimary}" font-weight="bold">S</text>
  <text x="34" y="45" font-family="monospace" font-size="24" fill="${brand}" font-weight="bold">/&gt;</text>
</svg>`

    const encoded = `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`

    document
      .querySelectorAll(
        'link[rel="icon"], link[rel="alternate icon"], link[rel="apple-touch-icon"]'
      )
      .forEach((link) => {
        // @ts-ignore
        link.href = encoded
        // @ts-ignore
        if (link.rel === 'icon') link.type = 'image/svg+xml'
      })
  }

  function getTheme() {
    const stored = localStorage.getItem('theme')
    if (stored && themes.some((t) => t.name === stored)) return stored
    // Default system preference if not stored
    if (
      window.matchMedia &&
      window.matchMedia('(prefers-color-scheme: dark)').matches
    ) {
      return 'midnight'
    }
    return 'mint'
  }

  // Initialize theme
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTheme(getTheme())
      initThemeToggle()
    })
  } else {
    setTheme(getTheme())
    initThemeToggle()
  }

  function toggleThemeRandom() {
    const current = getTheme()
    const available = themes.filter((t) => t.name !== current)
    const randomTheme = available[Math.floor(Math.random() * available.length)]
    setTheme(randomTheme.name)
  }

  function initThemeToggle() {
    document.querySelectorAll('[data-theme-toggle]').forEach((btn) => {
      btn.removeEventListener('click', toggleThemeRandom)
      btn.addEventListener('click', toggleThemeRandom)
    })
  }
</script>
