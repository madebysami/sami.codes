---
import { getCollection } from 'astro:content'
import BaseLayout from '../../../layouts/BaseLayout.astro'

export async function getStaticPaths() {
  const posts = await getCollection('blog')
  const allTags = [...new Set(posts.flatMap((post) => post.data.tags))]

  return allTags.map((tag) => ({
    params: { tag: tag.toLowerCase() },
    props: {
      tag,
      posts: posts
        .filter((post) => !post.data.draft && post.data.tags.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }))
}

const { tag, posts } = Astro.props

function readingTime(body: string): string {
  const words = body.split(/\s+/).length
  const minutes = Math.ceil(words / 200)
  return `${minutes} min read`
}
---

<BaseLayout
  title={`#${tag}`}
  description={`All posts tagged with "${tag}" on sami.codes.`}
>
  <section aria-labelledby="tag-heading" class="w-full">
    <div class="mb-6">
      <a
        href="/blog"
        class="block mb-6 text-sm font-mono text-brand hover:underline"
      >
        cd ../
      </a>
      <h1
        id="tag-heading"
        class="text-xs uppercase tracking-widest font-bold font-mono text-brand mb-2"
      >
        #{tag}
      </h1>
      <p class="text-text-secondary text-sm">
        {posts.length} {posts.length === 1 ? 'post' : 'posts'} tagged with "{tag}"
      </p>
    </div>

    <div class="flex flex-col gap-6">
      {
        posts.map((post) => (
          <a href={`/blog/${post.slug}`} class="block group">
            <div class="tech-card rounded-lg p-6 bg-surface border border-brand/20 transition-all duration-300 hover:-translate-y-1 hover:border-brand hover:shadow-lg hover:shadow-brand/20">
              <div class="flex flex-col sm:flex-row sm:items-baseline gap-2 mb-2">
                <time
                  datetime={post.data.pubDate.toISOString()}
                  class="text-xs font-mono text-text-secondary shrink-0"
                >
                  {post.data.pubDate.toLocaleDateString('en-GB', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                  })}
                </time>
                <h2 class="text-lg font-bold group-hover:underline text-text-primary">
                  {post.data.title}
                </h2>
              </div>
              <p class="text-sm mb-4 text-text-secondary">
                {post.data.description}
              </p>
              <div class="flex flex-wrap items-center justify-between gap-4">
                <ul
                  class="flex gap-2 font-mono text-xs flex-wrap list-none p-0 m-0"
                  role="list"
                >
                  {post.data.tags.map((t: string) => (
                    <li>
                      <a
                        href={`/blog/tags/${t.toLowerCase()}`}
                        class={`transition-colors ${t === tag ? 'text-text-primary font-bold' : 'text-brand hover:underline'}`}
                      >
                        {t}
                      </a>
                    </li>
                  ))}
                </ul>
                <span class="text-xs font-mono text-text-secondary">
                  [{readingTime(post.body)}]
                </span>
              </div>
            </div>
          </a>
        ))
      }
    </div>
  </section>
</BaseLayout>
